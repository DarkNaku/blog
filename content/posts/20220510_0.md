+++
draft = false
date = 2022-05-10T15:38:31+09:00
title = "Morton Code Encode / Decode"
description = ""
slug = ""
authors = []
tags = ["unity", "c#", "morton"]
categories = ["Code"]
externalLink = ""
series = []

+++

2차원 또는 3차원 좌표를  Z-curve 순서의 ulong형 값으로 변환하거나 복원하는 함수입니다.

자세한 내용은 [링크](https://www.forceflow.be/2013/10/07/morton-encodingdecoding-through-bit-interleaving-implementations)를 참고하세요.



아래 코드 좌표공간 최대값은 65535 입니다.



**3차원 좌표와 2진수 값 그리고 변환한 인덱스값**

```
node  | bits | index
-----:|:----:|:-----
0,0,0 |  000 |    0
0,0,1 |  001 |    1
0,1,0 |  010 |    2
0,1,1 |  011 |    3
1,0,0 |  100 |    4
1,0,1 |  101 |    5
1,1,0 |  110 |    6
1,1,1 |  111 |    7
```

```c# {linenos=table}
public static ulong MortonEncode2D(ulong x, ulong y) {
    x = (x | x << 32) & 0x1f00000000ffff;
    x = (x | x << 16) & 0x1f0000ff0000ff;
    x = (x | x << 8) & 0x100f00f00f00f00f;
    x = (x | x << 4) & 0x10c30c30c30c30c3;
    x = (x | x << 2) & 0x1249249249249249;

    y = (y | y << 32) & 0x1f00000000ffff;
    y = (y | y << 16) & 0x1f0000ff0000ff;
    y = (y | y << 8) & 0x100f00f00f00f00f;
    y = (y | y << 4) & 0x10c30c30c30c30c3;
    y = (y | y << 2) & 0x1249249249249249;

    return x | (y << 1);
}

public static void MortonDecode2D(ulong v, out ulong x, out ulong y) {
    x = v & 0x1249249249249249;
    x = (x ^ x >> 2) & 0x10c30c30c30c30c3;
    x = (x ^ x >> 4) & 0x100f00f00f00f00f;
    x = (x ^ x >> 8) & 0x1f0000ff0000ff;
    x = (x ^ x >> 16) & 0x1f00000000ffff;

    y = (v >> 1) & 0x1249249249249249;
    y = (y ^ y >> 2) & 0x10c30c30c30c30c3;
    y = (y ^ y >> 4) & 0x100f00f00f00f00f;
    y = (y ^ y >> 8) & 0x1f0000ff0000ff;
    y = (y ^ y >> 16) & 0x1f00000000ffff;
}

public static ulong MortonEncode3D(ulong x, ulong y, ulong z) {
    x = (x | x << 32) & 0x1f00000000ffff;
    x = (x | x << 16) & 0x1f0000ff0000ff;
    x = (x | x << 8) & 0x100f00f00f00f00f;
    x = (x | x << 4) & 0x10c30c30c30c30c3;
    x = (x | x << 2) & 0x1249249249249249;

    y = (y | y << 32) & 0x1f00000000ffff;
    y = (y | y << 16) & 0x1f0000ff0000ff;
    y = (y | y << 8) & 0x100f00f00f00f00f;
    y = (y | y << 4) & 0x10c30c30c30c30c3;
    y = (y | y << 2) & 0x1249249249249249;

    z = (z | z << 32) & 0x1f00000000ffff;
    z = (z | z << 16) & 0x1f0000ff0000ff;
    z = (z | z << 8) & 0x100f00f00f00f00f;
    z = (z | z << 4) & 0x10c30c30c30c30c3;
    z = (z | z << 2) & 0x1249249249249249;

    return x | (y << 1) | (z << 2);
}

public static void MortonDecode3D(ulong v, out ulong x, out ulong y, out ulong z) {
    x = v & 0x1249249249249249;
    x = (x ^ x >> 2) & 0x10c30c30c30c30c3;
    x = (x ^ x >> 4) & 0x100f00f00f00f00f;
    x = (x ^ x >> 8) & 0x1f0000ff0000ff;
    x = (x ^ x >> 16) & 0x1f00000000ffff;

    y = (v >> 1) & 0x1249249249249249;
    y = (y ^ y >> 2) & 0x10c30c30c30c30c3;
    y = (y ^ y >> 4) & 0x100f00f00f00f00f;
    y = (y ^ y >> 8) & 0x1f0000ff0000ff;
    y = (y ^ y >> 16) & 0x1f00000000ffff;

    z = (v >> 2) & 0x1249249249249249;
    z = (z ^ z >> 2) & 0x10c30c30c30c30c3;
    z = (z ^ z >> 4) & 0x100f00f00f00f00f;
    z = (z ^ z >> 8) & 0x1f0000ff0000ff;
    z = (z ^ z >> 16) & 0x1f00000000ffff;
}
```